<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SMPID - Dashboard Admin</title>
  
  <link rel="icon" href="icoppdag.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <!-- LOADING OVERLAY -->
  <div id="loadingOverlay" class="hidden">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
      <p class="mt-2 fw-bold text-dark">Sedang Memproses...</p>
    </div>
  </div>

  <!-- QUEUE MODAL (Tindakan Pantas) -->
  <div id="queueModal" class="queue-overlay hidden">
      <div class="queue-card">
          <button class="btn-close-queue" onclick="document.getElementById('queueModal').classList.add('hidden')" title="Tutup">&times;</button>
          
          <div class="queue-progress fw-bold text-muted mb-3" id="qProgress">Sasaran 1 / 10</div>
          <span class="badge bg-warning text-dark mb-3" id="qRoleBadge" style="font-size: 0.9em;">GPICT</span>
          
          <h3 class="queue-school fw-bold mb-1" id="qSchoolName">SK CONTOH</h3>
          <p class="text-muted small mb-1" id="qCode">MBA0000</p>
          <div class="queue-person text-success fw-bold mb-4 fs-5" id="qPersonName">Cikgu Ali</div>
          
          <div class="alert alert-light border small text-start mb-3 bg-light">
              <i class="fas fa-info-circle me-1 text-primary"></i> 
              Tekan butang hijau untuk buka WhatsApp Web dan hantar arahan pendaftaran bot.
          </div>

          <a href="#" id="qWaBtn" target="_blank" class="btn-wa-big" onclick="setTimeout(nextQueue, 1500)">
              <i class="fab fa-whatsapp fa-lg"></i> Hantar Mesej
          </a>
          
          <div class="d-flex gap-2">
            <button class="btn btn-light border w-50" onclick="prevQueue()" id="btnPrev">
                <i class="fas fa-chevron-left me-1"></i> Sebelum
            </button>
            <button class="btn btn-light border w-50" onclick="nextQueue()">
                Seterusnya <i class="fas fa-chevron-right ms-1"></i>
            </button>
          </div>
      </div>
  </div>

  <!-- HEADER -->
  <div class="header-bg text-center">
    <img src="icoppdag.png" alt="Logo PPD" class="mb-4" style="width: 200px; height: auto;">
    <h2 class="fw-bold px-3"><i class="fas fa-school me-2"></i>Dashboard Admin</h2>
    <p class="opacity-75">Unit Sumber Teknologi Pendidikan, Pejabat Pendidikan Daerah Alor Gajah</p>
  </div>

  <div class="container main-container pb-5">
    <div class="row justify-content-center">
      <div class="col-md-12">

        <!-- DASHBOARD ADMIN CARD -->
        <div id="dashboardCard" class="card p-4 shadow-sm">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 border-bottom pb-3 gap-2">
            <div>
                 <h4 class="mb-0 fw-bold text-primary"><i class="fas fa-tachometer-alt me-2"></i>Status Pendaftaran</h4>
                 <small class="text-muted">Pantau pendaftaran & hantar peringatan</small>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button onclick="mulaTindakanPantas()" class="btn btn-success btn-sm fw-bold shadow-sm">
                <i class="fab fa-whatsapp me-1"></i> Modul Tindakan Pantas
              </button>
              
              <button onclick="janaSenaraiTelegram()" class="btn btn-warning btn-sm text-dark fw-bold">
                <i class="fab fa-telegram-plane me-1"></i>List Telegram
              </button>
              <button onclick="keluarSistem()" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-sign-out-alt me-1"></i>Keluar
              </button>
            </div>
          </div>

          <div class="mb-4" id="filterContainer"></div>
          
          <div id="schoolGridWrapper"></div>
        </div>

      </div>
    </div>
  </div>

  <script src="js/utils.js"></script>
  <!-- Menambah main.js untuk memastikan fungsi keluarSistem() wujud -->
  <script src="js/main.js"></script>
  <script src="js/dashboard.js"></script>

  <!-- Logik Pembaikan Khas untuk Senarai Telegram -->
  <script>
    // Menggantikan fungsi placeholder dalam dashboard.js dengan logik asal yang betul
    function janaSenaraiTelegram() {
        // 'storedData' dan 'activeType' adalah global variable dari dashboard.js
        if (typeof storedData === 'undefined' || storedData.length === 0) {
            Swal.fire('Data Belum Sedia', 'Sila tunggu data dimuatkan sepenuhnya.', 'warning');
            return;
        }

        // 1. Tapis ikut jenis sekolah yang sedang aktif
        let list = (typeof activeType === 'undefined' || activeType === 'ALL') ? storedData : storedData.filter(i => i.jenis === activeType);
        
        // 2. Cari yang belum lengkap (nama_gpict kosong)
        // Logik asal: item.nama_gpict && item.nama_gpict.trim() !== "" bermaksud lengkap.
        // Kita nak yang !lengkap.
        const belumIsi = list.filter(item => !(item.nama_gpict && item.nama_gpict.trim() !== ""));

        if (belumIsi.length === 0) {
            Swal.fire('Tahniah', 'Tiada sekolah yang belum mengisi data dalam kategori ini.', 'success');
            return;
        }

        // 3. Group by Jenis (SK, SMK, dll)
        const groups = belumIsi.reduce((acc, item) => {
            const key = item.jenis || "LAIN-LAIN";
            if (!acc[key]) acc[key] = [];
            acc[key].push(item);
            return acc;
        }, {});

        // 4. Bina Mesej Format Telegram
        const tarikh = new Date().toLocaleDateString('ms-MY');
        let teks = `**SENARAI SEKOLAH BELUM ISI MAKLUMAT**\n`;
        
        if (typeof activeType !== 'undefined' && activeType !== 'ALL') {
            teks += `Kategori: ${activeType}\n`;
        }
        
        teks += `Tarikh: ${tarikh}\n\nMohon tindakan sekolah berikut:\n`;

        Object.keys(groups).sort().forEach(jenis => {
            teks += `\n**${jenis}**\n`;
            groups[jenis].forEach((school, index) => {
                teks += `${index + 1}. \`${school.kod_sekolah}\` - ${school.nama_sekolah}\n`;
            });
        });

        teks += `\nSila kemaskini di sistem segera.`;

        // 5. Salin ke Clipboard
        navigator.clipboard.writeText(teks).then(() => {
            Swal.fire({
                title: 'Berjaya Disalin!',
                text: 'Senarai telah disalin. Boleh terus tampal (Paste) di Telegram.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
        }).catch(err => {
            console.error(err);
            Swal.fire('Ralat', 'Gagal menyalin teks.', 'error');
        });
    }
  </script>
</body>
</html>