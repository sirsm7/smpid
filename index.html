<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Portal SMPID</title>
    <link rel="icon" href="icoppdag.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background: #f0f2f5; height: 100vh; display: flex; align-items: center; justify-content: center; font-family: sans-serif; }
        .login-card { width: 100%; max-width: 400px; border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); background: white; }
        .btn-menu { text-align: left; padding: 12px; margin-bottom: 8px; border: 1px solid #eee; border-radius: 8px; background: #fff; width: 100%; transition: all 0.2s; display: flex; align-items: center; text-decoration: none; color: #333; }
        .btn-menu:hover { background: #f8f9fa; border-color: #0d6efd; transform: translateX(5px); }
        .btn-menu i { width: 30px; font-size: 1.2rem; }
    </style>
</head>
<body>

<div class="login-card p-4">
    <div class="text-center mb-4">
        <img src="icoppdag.png" alt="Logo" width="80" class="mb-3">
        <h4 class="fw-bold">Portal SMPID</h4>
        <p class="text-muted small">PPD Alor Gajah</p>
    </div>

    <div id="loginForm">
        <div class="mb-3">
            <input type="text" id="inputKod" class="form-control text-center text-uppercase fw-bold py-2" placeholder="KOD SEKOLAH / M030">
        </div>
        <button onclick="handleLogin()" class="btn btn-primary w-100 fw-bold">LOG MASUK</button>
    </div>

    <div id="menuSelection" class="d-none">
        <div class="alert alert-primary py-2 text-center fw-bold small" id="welcomeText"></div>
        
        <div id="adminMenu" class="d-none">
            <a href="javascript:void(0)" onclick="goToOldDashboard('admin')" class="btn-menu">
                <i class="fas fa-tachometer-alt text-primary"></i> 
                <div>Dashboard Utama <div class="small text-muted" style="font-size:0.7em">Data, Filter & WhatsApp Queue</div></div>
            </a>
            <a href="email.html" class="btn-menu">
                <i class="fas fa-envelope text-success"></i> Email Blaster
            </a>
            <a href="helpdesk.html?role=admin" class="btn-menu">
                <i class="fas fa-comments text-warning"></i> Pusat Mesej (Helpdesk)
            </a>
        </div>

        <div id="schoolMenu" class="d-none">
            <a href="javascript:void(0)" onclick="goToOldDashboard('school')" class="btn-menu">
                <i class="fas fa-user-edit text-primary"></i> 
                <div>Profil Sekolah <div class="small text-muted" style="font-size:0.7em">Kemaskini Nama & No Tel</div></div>
            </a>
            <a href="helpdesk.html?role=school" class="btn-menu">
                <i class="fas fa-headset text-danger"></i> Aduan & Pertanyaan
            </a>
        </div>

        <button onclick="location.reload()" class="btn btn-sm btn-link text-danger w-100 mt-3 text-decoration-none">Keluar</button>
    </div>
</div>

<script>
    // KUNCI SUPABASE ANDA
    const supabase = supabase.createClient('https://hbanvnteyncwsnfprahz.supabase.co', 'sb_publishable_IEcWCbBmqWLBOBU4rl0FPw_Z97Assvt');

    async function handleLogin() {
        const kod = document.getElementById('inputKod').value.trim().toUpperCase();
        if(!kod) return Swal.fire('Ralat', 'Sila masukkan kod', 'warning');

        // LOGIN ADMIN
        if(kod === 'M030') {
            showMenu('admin', 'Admin PPD');
            return;
        }

        // LOGIN SEKOLAH
        Swal.showLoading();
        const { data, error } = await supabase.from('sekolah_data').select('kod_sekolah, nama_sekolah').eq('kod_sekolah', kod).single();
        Swal.close();

        if(data) {
            localStorage.setItem('smpid_school_code', data.kod_sekolah); // Simpan untuk Helpdesk
            localStorage.setItem('temp_school_name', data.nama_sekolah);
            showMenu('school', data.nama_sekolah);
        } else {
            Swal.fire('Tiada Rekod', 'Kod sekolah salah.', 'error');
        }
    }

    function showMenu(role, name) {
        document.getElementById('loginForm').classList.add('d-none');
        document.getElementById('menuSelection').classList.remove('d-none');
        document.getElementById('welcomeText').innerText = name;
        if(role === 'admin') document.getElementById('adminMenu').classList.remove('d-none');
        else document.getElementById('schoolMenu').classList.remove('d-none');
    }

    // FUNGSI PENTING: Buka dashboard.html (fail lama) dan bypass login
    function goToOldDashboard(role) {
        if(role === 'admin') {
            // Kita set sessionStorage supaya dashboard.html ingat kita dah login
            // (Rujuk baris 234 fail asal anda: sessionStorage.setItem('smpid_auth', 'true'))
            sessionStorage.setItem('smpid_auth', 'true');
            window.location.href = 'dashboard.html';
        } else {
            // Untuk sekolah, dashboard.html asal tiada auto-login direct url, 
            // jadi kita minta mereka masukkan kod semula atau kita boleh ubah dashboard.html sikit.
            // Paling selamat tanpa ubah kod lama:
            Swal.fire({
                title: 'Pengalihan',
                text: 'Sila masukkan Kod Sekolah anda sekali lagi di halaman profil untuk pengesahan.',
                icon: 'info',
                confirmButtonText: 'Teruskan'
            }).then(() => {
                window.location.href = 'dashboard.html';
            });
        }
    }
</script>
</body>
</html>