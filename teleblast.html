<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SMPID - Telegram Blaster</title>
  <link rel="icon" href="icoppdag.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    body { background-color: #f0f4f8; font-family: 'Inter', sans-serif; }
    .header-blast { background: #0088cc; color: white; padding: 1.5rem 0; margin-bottom: 2rem; } /* Warna Telegram */
    .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-radius: 12px; }
    .id-box { background: #eef2f5; font-family: monospace; font-size: 0.85rem; color: #555; }
    
    /* Toolbar Editor Style */
    .editor-toolbar {
        background: #f8f9fa;
        border: 1px solid #ced4da;
        border-bottom: none;
        border-radius: 6px 6px 0 0;
        padding: 8px;
        display: flex;
        gap: 5px;
    }
    .editor-textarea {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }
    .btn-tool {
        border: 1px solid #dee2e6;
        background: white;
        color: #495057;
        padding: 4px 10px;
        font-size: 0.85rem;
        border-radius: 4px;
        transition: all 0.2s;
    }
    .btn-tool:hover { background: #e9ecef; border-color: #ced4da; }
  </style>
</head>
<body>

  <div class="header-blast">
    <div class="container d-flex justify-content-between align-items-center">
        <h3 class="mb-0 fw-bold"><i class="fab fa-telegram-plane me-2"></i>Telegram Blaster</h3>
        <a href="index.html" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left me-2"></i>Kembali</a>
    </div>
  </div>

  <div class="container pb-5">
    <div class="row">
        <!-- PANEL KIRI: PENAPIS PENERIMA -->
        <div class="col-lg-4 mb-4">
            <div class="card p-4">
                <h5 class="fw-bold mb-3 text-primary">1. Sasaran Penerima</h5>
                
                <div class="mb-3">
                    <label class="form-label fw-bold small text-muted">JAWATAN:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkGpict" checked onchange="generateList()">
                        <label class="form-check-label" for="checkGpict">GPICT</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="checkAdmin" checked onchange="generateList()">
                        <label class="form-check-label" for="checkAdmin">Admin DELIMa</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold small text-muted">JENIS SEKOLAH:</label>
                    <select class="form-select" id="typeFilter" onchange="generateList()">
                        <option value="ALL" selected>Semua Jenis</option>
                        <!-- Pilihan akan dijana secara dinamik -->
                    </select>
                </div>

                <div class="card bg-light p-3 border-0">
                    <div class="d-flex justify-content-between"><span>Jumlah Sekolah:</span> <strong id="countSchool">0</strong></div>
                    <div class="d-flex justify-content-between text-primary mt-1"><span>ID Telegram Dijumpai:</span> <strong id="countTele">0</strong></div>
                </div>
                
                <div class="mt-3">
                    <label class="form-label small text-muted">ID Debug (Untuk Semakan):</label>
                    <textarea id="teleOutput" class="form-control id-box" rows="3" readonly></textarea>
                </div>
            </div>
        </div>

        <!-- PANEL KANAN: KANDUNGAN MESEJ -->
        <div class="col-lg-8">
            <div class="card p-4">
                <h5 class="fw-bold mb-3 text-primary">2. Kandungan Mesej</h5>
                
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle me-2"></i> Mesej akan dihantar oleh <b>Bot SMPID</b>. Format yang disokong: Markdown.
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Editor Teks:</label>
                    
                    <!-- TOOLBAR EDITING -->
                    <div class="editor-toolbar" role="group">
                        <button type="button" class="btn-tool" onclick="insertFormat('*', '*')" title="Bold (Tebal)">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="btn-tool" onclick="insertFormat('_', '_')" title="Italic (Condong)">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button type="button" class="btn-tool" onclick="insertFormat('`', '`')" title="Monospace (Kod)">
                            <i class="fas fa-code"></i>
                        </button>
                        <div style="border-left: 1px solid #ddd; margin: 0 5px;"></div>
                        <button type="button" class="btn-tool" onclick="insertLink()" title="Pautan URL">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>

                    <textarea class="form-control editor-textarea" id="msgBody" rows="8" placeholder="Tulis hebahan anda di sini..."></textarea>
                    <div class="form-text text-end">Contoh Pautan: [Teks](URL)</div>
                </div>

                <hr>
                
                <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-secondary" onclick="resetForm()"><i class="fas fa-undo me-2"></i>Reset</button>
                    <!-- BUTANG UJI LARI DIKEMASKINI -->
                    <button class="btn btn-warning" onclick="ujiLari()"><i class="fas fa-vial me-2"></i>Uji Lari (Admin)</button>
                    <button class="btn btn-primary" onclick="hantarBlast()"><i class="fas fa-paper-plane me-2"></i>Hantar Semua</button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <script>
    // --- SEMAKAN LOGIN ADMIN ---
    if (sessionStorage.getItem('smpid_auth') !== 'true') {
        alert("Sila log masuk sebagai Admin terlebih dahulu.");
        window.location.href = 'index.html';
    }

    // --- KONFIGURASI SUPABASE ---
    const SUPABASE_URL = 'https://hbanvnteyncwsnfprahz.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_IEcWCbBmqWLBOBU4rl0FPw_Z97Assvt'; 
    const sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- KONFIGURASI BOT API (Endpoint Deno Deploy Anda) ---
    const BOT_API_URL = "https://smpid-bot.deno.dev/api/blast"; 
    const BOT_SECRET_KEY = "rahsia_ppd_melaka"; 

    let rawData = [];
    let targetIds = [];

    // --- FUNGSI UTAMA ---
    document.addEventListener("DOMContentLoaded", async () => {
        Swal.fire({title: 'Memuatkan Data...', didOpen: () => Swal.showLoading()});
        
        const { data, error } = await sbClient
            .from('sekolah_data')
            .select('*');
            
        if (error) { 
            console.error(error);
            Swal.fire('Ralat', 'Gagal sambungan database.', 'error'); 
            return; 
        }
        
        rawData = data || [];
        document.getElementById('countSchool').innerText = rawData.length;
        
        populateTypeFilter(rawData);
        generateList();
        
        Swal.close();
    });

    function populateTypeFilter(data) {
        const types = [...new Set(data.map(item => item.jenis_sekolah || 'LAIN-LAIN'))].sort();
        const select = document.getElementById('typeFilter');
        select.innerHTML = '<option value="ALL" selected>Semua Jenis</option>';
        types.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type;
            opt.innerText = type;
            select.appendChild(opt);
        });
    }

    function generateList() {
        const includeGpict = document.getElementById('checkGpict').checked;
        const includeAdmin = document.getElementById('checkAdmin').checked;
        const typeFilter = document.getElementById('typeFilter').value;
        
        const uniqueIds = new Set();

        if (!rawData) return;

        rawData.forEach(row => {
            const rowJenis = row.jenis_sekolah || 'LAIN-LAIN';
            if (typeFilter !== 'ALL' && rowJenis !== typeFilter) return;

            if (includeGpict && row.telegram_id_gpict && String(row.telegram_id_gpict).trim() !== "") {
                uniqueIds.add(String(row.telegram_id_gpict));
            }
            if (includeAdmin && row.telegram_id_admin && String(row.telegram_id_admin).trim() !== "") {
                uniqueIds.add(String(row.telegram_id_admin));
            }
        });

        targetIds = Array.from(uniqueIds);
        document.getElementById('countTele').innerText = targetIds.length;
        document.getElementById('teleOutput').value = targetIds.join(', ');
    }

    // --- FUNGSI EDITOR TEKS ---
    function insertFormat(startTag, endTag) {
        const textarea = document.getElementById('msgBody');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        const selectedText = text.substring(start, end);
        const replacement = startTag + selectedText + endTag;
        textarea.value = text.substring(0, start) + replacement + text.substring(end);
        textarea.focus();
        textarea.selectionStart = start + replacement.length;
        textarea.selectionEnd = start + replacement.length;
    }

    function insertLink() {
        const url = prompt("Masukkan URL pautan:", "https://");
        if (url) {
            insertFormat("[", "](" + url + ")");
        }
    }

    // --- FUNGSI UJI LARI (AUTO ADMIN_USERS) ---
    async function ujiLari() {
        const message = document.getElementById('msgBody').value.trim();
        if (!message) {
            Swal.fire('Mesej Kosong', 'Sila tulis kandungan mesej dahulu.', 'warning');
            return;
        }

        // Papar loading sementara fetch admin IDs
        Swal.fire({
            title: 'Mencari Data Admin...',
            didOpen: () => Swal.showLoading()
        });

        try {
            // Tarik semua ID dari table admin_users
            const { data, error } = await sbClient
                .from('admin_users')
                .select('telegram_id');

            if (error) throw error;

            if (!data || data.length === 0) {
                Swal.fire('Tiada Admin', 'Tiada rekod admin dijumpai dalam sistem (table: admin_users). Sila daftar di Bot Telegram dengan menghantar kod M030.', 'error');
                return;
            }

            // Extract IDs ke dalam array string
            const adminIds = data.map(u => String(u.telegram_id));

            // Sahkan dengan pengguna
            const confirm = await Swal.fire({
                title: 'Uji Lari (Admin Mode)',
                text: `Mesej akan dihantar kepada ${adminIds.length} orang Admin yang berdaftar dalam sistem (termasuk anda). Teruskan?`,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-paper-plane me-2"></i>Hantar Ujian',
                confirmButtonColor: '#ffc107', // Warna Kuning
                cancelButtonColor: '#6c757d'
            });

            if (confirm.isConfirmed) {
                laksanaPenghantaran(adminIds, message, true);
            }

        } catch (err) {
            console.error(err);
            Swal.fire('Ralat Sistem', 'Gagal membaca senarai admin dari pangkalan data.', 'error');
        }
    }

    // --- FUNGSI PENGHANTARAN SEBENAR ---
    async function hantarBlast() {
        const message = document.getElementById('msgBody').value.trim();
        
        if (targetIds.length === 0) {
            Swal.fire('Tiada Penerima', 'Sila pilih sasaran yang mempunyai ID Telegram.', 'warning');
            return;
        }
        if (!message) {
            Swal.fire('Mesej Kosong', 'Sila tulis kandungan mesej.', 'warning');
            return;
        }

        const confirm = await Swal.fire({
            title: 'Sahkan Penghantaran?',
            text: `AMARAN: Mesej akan dihantar kepada ${targetIds.length} orang penerima sebenar (Sekolah).`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Hantar!',
            confirmButtonColor: '#0088cc',
            cancelButtonColor: '#d33'
        });

        if (!confirm.isConfirmed) return;

        // Hantar ke semua targetIds
        laksanaPenghantaran(targetIds, message, false);
    }

    // --- FUNGSI TERAS API (BACKEND CALL) ---
    async function laksanaPenghantaran(ids, message, isTest) {
        Swal.fire({
            title: isTest ? 'Ujian Sedang Dijalankan...' : 'Sedang Menghantar...', 
            text: 'Jangan tutup paparan ini.', 
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const response = await fetch(BOT_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    secret: BOT_SECRET_KEY,
                    ids: ids,
                    message: message
                })
            });

            const result = await response.json();

            if (result.success) {
                const msgText = isTest 
                    ? `Mesej ujian berjaya dihantar kepada ${result.sent_count} orang Admin.` 
                    : `Mesej berjaya dihantar kepada ${result.sent_count} orang penerima.`;

                Swal.fire('Berjaya!', msgText, 'success');
            } else {
                throw new Error(result.error || 'Ralat tidak diketahui');
            }

        } catch (err) {
            console.error(err);
            Swal.fire('Gagal', 'Gagal menghubungi server Bot. Pastikan URL API betul.', 'error');
        }
    }

    function resetForm() {
        document.getElementById('msgBody').value = "";
    }
  </script>
</body>
</html>